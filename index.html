<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LEH Student Attendance System</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      overflow: auto;
    }

    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 15px;
      background: rgba(255, 255, 255, 0.95);
      color: #333;
    }

    .header {
      text-align: center;
      margin-bottom: 10px;
      padding: 10px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #1e3c72;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .logo {
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      margin: 8px auto;
      font-weight: bold;
      text-align: center;
      max-width: 300px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .logo-main { 
      font-size: 32px; 
      font-weight: 900; 
      letter-spacing: 2px;
    }
    .logo-sub { 
      font-size: 12px; 
      margin-top: 4px;
      letter-spacing: 1px;
    }

    .instructions {
      background: #fff3cd;
      color: #856404;
      padding: 12px 15px;
      border-radius: 10px;
      margin: 10px 0;
      font-size: 14px;
      border: 1px solid #ffeaa7;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .main-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 15px 0;
      flex: 1;
    }

    .camera-section {
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
    }

    .camera-container {
      width: 100%;
      height: 40vh;
      min-height: 300px;
      background: #000;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      border: 3px solid #ffcc00;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    #video { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
    }

    .scan-overlay {
      position: absolute;
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%; 
      height: 65%;
      border: 3px solid #00ff00;
      border-radius: 12px;
      background: rgba(0, 255, 0, 0.1);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .scan-text {
      position: absolute;
      bottom: -40px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #00ff00;
      font-weight: bold;
      font-size: 16px;
      text-shadow: 0 0 5px rgba(0,0,0,0.8);
      z-index: 11;
    }

    .camera-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }

    .camera-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      min-width: 120px;
    }
    .camera-btn.start { 
      background: linear-gradient(to bottom, #4CAF50, #45a049);
      color: white; 
    }
    .camera-btn.stop { 
      background: linear-gradient(to bottom, #f44336, #d32f2f);
      color: white; 
    }
    .camera-btn:disabled { 
      background: #b0b0b0; 
      cursor: not-allowed;
    }

    .students-section {
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
    }

    .section-title {
      background: #1e3c72;
      color: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .selected-student-notice {
      background: #ffc107;
      color: #856404;
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    .selected-student-notice.show {
      display: block;
      animation: fadeIn 0.5s;
    }

    .students-list {
      flex: 1;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      border: 2px solid #dee2e6;
      overflow-y: auto;
      max-height: 400px;
    }

    .student-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      margin-bottom: 8px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      transition: all 0.3s;
    }

    .student-item.selected {
      background: #e3f2fd;
      border: 2px solid #2196F3;
      transform: translateX(5px);
    }

    .student-item.present {
      background: #d4edda;
      border-color: #28a745;
    }

    .student-item.absent {
      background: #f8d7da;
      border-color: #dc3545;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .student-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .student-details {
      display: flex;
      flex-direction: column;
    }

    .student-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }

    .student-id {
      font-size: 12px;
      color: #666;
    }

    .check-in-time {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .attendance-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attendance-btn {
      padding: 6px 15px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mark-present {
      background: #28a745;
      color: white;
    }

    .mark-present:hover:not(:disabled) {
      background: #218838;
    }

    .mark-absent {
      background: #dc3545;
      color: white;
    }

    .mark-absent:hover:not(:disabled) {
      background: #c82333;
    }

    .attendance-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .attendance-status {
      font-size: 12px;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      min-width: 60px;
      text-align: center;
    }

    .status-present {
      background: #d4edda;
      color: #155724;
    }

    .status-absent {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .verify-section {
      width: 100%;
      margin: 15px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .verify-btn {
      padding: 15px 40px;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: linear-gradient(to bottom, #2196F3, #1976D2);
      color: white;
      margin-bottom: 15px;
      min-width: 200px;
    }

    .verify-btn:hover:not(:disabled) {
      background: linear-gradient(to bottom, #1976D2, #1565C0);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }

    .verify-btn:disabled { 
      background: #b0b0b0; 
      cursor: not-allowed;
    }

    .status-container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .status-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.5s;
    }

    .status-box.verified { 
      background: #d4edda; 
      border-color: #28a745; 
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    #statusText {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
      text-align: center;
    }

    .verified-tick { 
      font-size: 42px; 
      display: none; 
    }
    .show { 
      display: block; 
      animation: bounce 0.6s; 
    }
    @keyframes bounce {
      0%,20%,60%,100% { transform: scale(1); }
      40% { transform: scale(1.3); }
      80% { transform: scale(1.1); }
    }

    .attendance-summary {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      width: 100%;
      max-width: 800px;
    }

    .summary-item {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 120px;
    }

    .summary-count {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .summary-present {
      color: #28a745;
    }

    .summary-absent {
      color: #dc3545;
    }

    .summary-total {
      color: #1e3c72;
    }

    .database-status {
      margin-top: 15px;
      padding: 10px;
      background: #e7f3ff;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      color: #004085;
      display: none;
    }

    .database-status.show {
      display: block;
      animation: fadeIn 0.5s;
    }

    .admin-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .admin-btn {
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .admin-btn:hover {
      background: #5a6268;
    }

    .config-section {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .config-input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .config-label {
      display: block;
      margin: 5px 0;
      font-weight: bold;
      color: #555;
    }

    .date-info {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin: 5px 0;
    }

    .export-controls {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .export-btn {
      padding: 8px 16px;
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .export-btn:hover {
      background: #138496;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .camera-container {
        height: 35vh;
      }
      
      .admin-controls, .export-controls {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>LEH STUDENT ATTENDANCE SYSTEM</h1>
      <!-- <div class="logo">
        <div class="logo-main">LEH</div>
        <div class="logo-sub">LEARNING EDUCATION HUB</div>
      </div> -->
      <div id="currentDate" class="date-info"></div>
      <!-- <div class="date-info">Data saves to browser storage - Works 100% offline!</div> -->
    </div>

  <!-- <div class="instructions">
      <strong>INSTRUCTIONS:</strong><br>
      1. Select student from list (click Mark Present)<br>
      2. Click START CAMERA and show ID card<br>
      3. Click VERIFY NOW to record attendance<br>
      4. Only selected student's attendance will be marked
    </div>   -->

    <div class="config-section">
      <div class="config-label">üìÖ Today's Date: <span id="todayDate"></span></div>
      <div class="config-label">üíæ Data Management:</div>
      <div class="export-controls">
        <button id="exportBtn" class="export-btn">üì§ Export All Data</button>
        <button id="importBtn" class="export-btn">üì• Import Data</button>
        <button id="resetBtn" class="export-btn" style="background: #dc3545;">üóëÔ∏è Reset Today</button>
        <button id="newDayBtn" class="export-btn" style="background: #28a745;">‚ú® New Day</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>

    <div class="main-content">
      <div class="camera-section">
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <div class="scan-overlay">
            <div class="scan-text">Scan ID Card Here</div>
          </div>
        </div>
        
        <div class="camera-controls">
          <button id="startBtn" class="camera-btn start">START CAMERA</button>
          <button id="stopBtn" class="camera-btn stop" disabled>STOP CAMERA</button>
        </div>
      </div>

      <div class="verify-section">
      <button id="verifyBtn" class="verify-btn" disabled>
        <span>üì∑</span> VERIFY SELECTED STUDENT 
      </button>

      <div class="status-container">
        <div class="status-box" id="statusBox">
          <div id="statusText">Select a student first, then start camera</div>
          <div id="verifiedTick" class="verified-tick">‚úÖ</div>
        </div>
      </div>

      <div class="students-section">
        <div class="section-title">
          STUDENTS LIST - LEH
          <div style="font-size: 12px; font-weight: normal; margin-top: 5px;">
            Click "Mark Present" to select student for verification
          </div>
        </div>

        <div class="selected-student-notice" id="selectedNotice">
          Selected: <span id="selectedStudentName"></span> - Ready for verification!
        </div>

        <div class="students-list" id="studentsList">
          <!-- Student list will be populated by JavaScript -->
        </div>
        <div class="admin-controls">
          <button id="refreshBtn" class="admin-btn">üîÑ Refresh List</button>
          <button id="addStudentBtn" class="admin-btn">‚ûï Add Student</button>
          <button id="markAllAbsentBtn" class="admin-btn">‚ö†Ô∏è Mark All Unmarked as Absent</button>
        </div>
      </div>
    </div>

    

      <div class="attendance-summary">
        <div class="summary-item">
          <div class="summary-count summary-present" id="presentCount">0</div>
          <div>Present</div>
        </div>
        <div class="summary-item">
          <div class="summary-count" id="unmarkedCount" style="color: #ffc107;">0</div>
          <div>Unmarked</div>
        </div>
        <div class="summary-item">
          <div class="summary-count summary-absent" id="absentCount">0</div>
          <div>Absent</div>
        </div>
        <div class="summary-item">
          <div class="summary-count summary-total" id="totalCount">0</div>
          <div>Total</div>
        </div>
      </div>
      
      <div class="database-status" id="dbStatus">
        Data saved to browser storage!
      </div>
    </div>
  </div>

  <script>
    // ==================== ATTENDANCE SYSTEM ====================
    class AttendanceSystem {
      constructor() {
        // DOM Elements
        this.video = document.getElementById('video');
        this.startBtn = document.getElementById('startBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.verifyBtn = document.getElementById('verifyBtn');
        this.statusText = document.getElementById('statusText');
        this.verifiedTick = document.getElementById('verifiedTick');
        this.statusBox = document.getElementById('statusBox');
        this.studentsList = document.getElementById('studentsList');
        this.dbStatus = document.getElementById('dbStatus');
        this.presentCount = document.getElementById('presentCount');
        this.absentCount = document.getElementById('absentCount');
        this.unmarkedCount = document.getElementById('unmarkedCount');
        this.totalCount = document.getElementById('totalCount');
        this.refreshBtn = document.getElementById('refreshBtn');
        this.markAllAbsentBtn = document.getElementById('markAllAbsentBtn');
        this.addStudentBtn = document.getElementById('addStudentBtn');
        this.currentDate = document.getElementById('currentDate');
        this.todayDate = document.getElementById('todayDate');
        this.exportBtn = document.getElementById('exportBtn');
        this.importBtn = document.getElementById('importBtn');
        this.importFile = document.getElementById('importFile');
        this.resetBtn = document.getElementById('resetBtn');
        this.newDayBtn = document.getElementById('newDayBtn');
        this.selectedNotice = document.getElementById('selectedNotice');
        this.selectedStudentName = document.getElementById('selectedStudentName');
        
        // State
        this.stream = null;
        this.isVerified = false;
        this.students = [];
        this.selectedStudentId = null;
        this.database = this.initDatabase();
        
        // Initialize
        this.setupEventListeners();
        this.showCurrentDate();
        this.loadStudents();
      }

      // Simple localStorage database
      initDatabase() {
        const storageKey = 'leh_attendance_v3';
        
        return {
          getStudents: () => {
            const data = localStorage.getItem(storageKey);
            if (!data) {
              // Default students
              const defaultStudents = [
                { id: 'LEH2024001', name: 'Aarav Sharma', class: '12A', present: false, scanned: false },
                { id: 'LEH2024002', name: 'Vivaan Patel', class: '12A', present: false, scanned: false },
                { id: 'LEH2024003', name: 'Aditya Singh', class: '12A', present: false, scanned: false },
                { id: 'LEH2024004', name: 'Vihaan Kumar', class: '12A', present: false, scanned: false },
                { id: 'LEH2024005', name: 'Arjun Gupta', class: '12A', present: false, scanned: false },
                { id: 'LEH2024006', name: 'Sai Reddy', class: '12A', present: false, scanned: false },
                { id: 'LEH2024007', name: 'Reyansh Joshi', class: '12A', present: false, scanned: false },
                { id: 'LEH2024008', name: 'Mohammed Khan', class: '12A', present: false, scanned: false },
                { id: 'LEH2024009', name: 'Ishaan Verma', class: '12A', present: false, scanned: false },
                { id: 'LEH2024010', name: 'Kabir Malhotra', class: '12A', present: false, scanned: false }
              ];
              localStorage.setItem(storageKey, JSON.stringify(defaultStudents));
              return defaultStudents;
            }
            return JSON.parse(data);
          },
          
          saveStudents: (students) => {
            localStorage.setItem(storageKey, JSON.stringify(students));
          },
          
          addStudent: (student) => {
            const students = this.database.getStudents();
            students.push(student);
            this.database.saveStudents(students);
            return student;
          }
        };
      }

      showCurrentDate() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        this.currentDate.textContent = now.toLocaleDateString('en-US', options);
        this.todayDate.textContent = now.toISOString().split('T')[0];
      }

      loadStudents() {
        try {
          this.students = this.database.getStudents();
          this.renderStudents();
          this.updateSummary();
          this.statusText.textContent = "Select a student from the list";
        } catch (error) {
          console.error('Error loading students:', error);
          this.statusText.textContent = "Error loading students";
        }
      }

      updateSummary() {
        const present = this.students.filter(s => s.present).length;
        const absent = this.students.filter(s => s.scanned && !s.present).length;
        const total = this.students.length;
        const unmarked = total - present - absent;
        
        this.presentCount.textContent = present;
        this.absentCount.textContent = absent;
        this.unmarkedCount.textContent = unmarked;
        this.totalCount.textContent = total;
      }

      renderStudents() {
        this.studentsList.innerHTML = '';
        
        this.students.forEach((student) => {
          const studentElement = document.createElement('div');
          
          // Determine class based on status
          let statusClass = '';
          let statusText = 'PENDING';
          let statusCssClass = 'status-pending';
          
          if (student.scanned) {
            if (student.present) {
              statusClass = 'present';
              statusText = 'PRESENT';
              statusCssClass = 'status-present';
            } else {
              statusClass = 'absent';
              statusText = 'ABSENT';
              statusCssClass = 'status-absent';
            }
          }
          
          // Add selected class if this is the selected student
          const isSelected = student.id === this.selectedStudentId;
          const selectedClass = isSelected ? 'selected' : '';
          
          studentElement.className = `student-item ${statusClass} ${selectedClass}`;
          
          const avatarText = student.name.split(' ').map(n => n[0]).join('');
          
          studentElement.innerHTML = `
            <div class="student-info">
              <div class="student-avatar">${avatarText}</div>
              <div class="student-details">
                <div class="student-name">${student.name}</div>
                <div class="student-id">${student.id}</div>
                ${student.check_in_time ? `<div class="check-in-time">Checked in: ${student.check_in_time}</div>` : ''}
              </div>
            </div>
            <div class="attendance-controls">
              <div class="attendance-status ${statusCssClass}">
                ${statusText}
              </div>
              <button class="attendance-btn mark-present" data-id="${student.id}" ${student.present ? 'disabled' : ''}>
                ${student.present ? '‚úì Present' : 'Mark Present'}
              </button>
              <button class="attendance-btn mark-absent" data-id="${student.id}" ${!student.present && student.scanned ? 'disabled' : ''}>
                ${!student.present && student.scanned ? 'Absent' : 'Mark Absent'}
              </button>
            </div>
          `;
          
          this.studentsList.appendChild(studentElement);
        });
        
        // Add event listeners for Present buttons
        document.querySelectorAll('.mark-present').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const studentId = e.target.dataset.id;
            this.selectStudent(studentId);
          });
        });
        
        // Add event listeners for Absent buttons
        document.querySelectorAll('.mark-absent').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const studentId = e.target.dataset.id;
            this.markAbsent(studentId);
          });
        });
        
        // Add click event to select student
        document.querySelectorAll('.student-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (!e.target.classList.contains('attendance-btn')) {
              const studentId = item.querySelector('.mark-present').dataset.id;
              this.selectStudent(studentId);
            }
          });
        });
      }

      selectStudent(studentId) {
        // Find the student
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        // Set as selected
        this.selectedStudentId = studentId;
        
        // Update notice
        this.selectedStudentName.textContent = student.name;
        this.selectedNotice.classList.add('show');
        
        // Update status message
        this.statusText.textContent = `Selected: ${student.name}. Now start camera and verify.`;
        
        // Enable verify button if camera is ready
        if (this.stream) {
          this.verifyBtn.disabled = false;
        }
        
        // Re-render to show selection
        this.renderStudents();
        
        // Show database status
        this.showDatabaseStatus(`Selected ${student.name} for verification`, 'info');
      }

      markAbsent(studentId) {
        const student = this.students.find(s => s.id === studentId);
        if (!student) return;
        
        // Mark as absent
        student.scanned = true;
        student.present = false;
        student.check_in_time = new Date().toTimeString().split(' ')[0];
        
        // Save to database
        this.database.saveStudents(this.students);
        
        // Update UI
        this.renderStudents();
        this.updateSummary();
        
        // If this was the selected student, clear selection
        if (this.selectedStudentId === studentId) {
          this.clearSelection();
        }
        
        this.showDatabaseStatus(`${student.name} marked absent`, 'info');
      }

      clearSelection() {
        this.selectedStudentId = null;
        this.selectedNotice.classList.remove('show');
        this.verifyBtn.disabled = true;
        this.statusText.textContent = "Select a student from the list";
        this.renderStudents();
      }

      setupEventListeners() {
        this.startBtn.addEventListener('click', () => this.startCamera());
        this.stopBtn.addEventListener('click', () => this.stopCamera());
        this.verifyBtn.addEventListener('click', () => this.verifyStudent());
        this.refreshBtn.addEventListener('click', () => this.loadStudents());
        this.markAllAbsentBtn.addEventListener('click', () => this.markAllUnmarkedAsAbsent());
        this.addStudentBtn.addEventListener('click', () => this.addNewStudent());
        this.exportBtn.addEventListener('click', () => this.exportData());
        this.importBtn.addEventListener('click', () => this.importData());
        this.importFile.addEventListener('change', (e) => this.handleImportFile(e));
        this.resetBtn.addEventListener('click', () => this.resetTodayAttendance());
        this.newDayBtn.addEventListener('click', () => this.startNewDay());

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // SPACE to verify (only if student is selected and camera is on)
          if (e.code === 'Space' && this.stream && !this.isVerified && this.selectedStudentId) {
            e.preventDefault();
            this.verifyStudent();
          }
        });
      }

      async startCamera() {
        if (!this.selectedStudentId) {
          this.statusText.textContent = "Please select a student first";
          return;
        }

        try {
          this.stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'user',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          });

          this.video.srcObject = this.stream;
          this.video.onloadedmetadata = () => {
            this.video.play();
            this.startBtn.disabled = true;
            this.stopBtn.disabled = false;
            this.verifyBtn.disabled = false;
            const student = this.students.find(s => s.id === this.selectedStudentId);
            this.statusText.textContent = `Camera ready! Verify ID for ${student.name}`;
          };

        } catch (error) {
          console.error('Camera error:', error);
          let errorMessage = 'Camera Error: ';
          if (error.name === 'NotAllowedError') {
            errorMessage += 'Please allow camera permission';
          } else if (error.name === 'NotFoundError') {
            errorMessage += 'No camera found';
          } else {
            errorMessage += 'Please check your camera';
          }
          this.statusText.textContent = errorMessage;
        }
      }

      stopCamera() {
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
        }
        this.isVerified = false;
        this.startBtn.disabled = false;
        this.stopBtn.disabled = true;
        this.verifyBtn.disabled = true;
        this.statusText.textContent = "Camera stopped";
        this.hideVerified();
      }

      verifyStudent() {
        if (this.isVerified || !this.selectedStudentId || !this.stream) return;
        
        const student = this.students.find(s => s.id === this.selectedStudentId);
        if (!student) {
          this.statusText.textContent = "Student not found";
          return;
        }
        
        this.isVerified = true;
        this.verifyBtn.disabled = true;
        
        // Simulate ID card scanning
        this.statusText.textContent = `üîç Scanning ID Card for ${student.name}...`;
        
        setTimeout(() => {
          // Mark as present
          student.scanned = true;
          student.present = true;
          student.check_in_time = new Date().toTimeString().split(' ')[0];
          
          // Save to database
          this.database.saveStudents(this.students);
          
          // Update UI
          this.renderStudents();
          this.updateSummary();
          
          // Show success message
          this.statusText.textContent = `‚úÖ VERIFIED! ${student.name}`;
          this.statusBox.classList.add('verified');
          this.verifiedTick.classList.add('show');
          
          this.showDatabaseStatus(`${student.name} attendance recorded`, 'success');
          
          // Clear selection and reset for next student
          setTimeout(() => {
            this.clearSelection();
            this.resetForNextStudent();
          }, 3000);
        }, 1500);
      }
      
      resetForNextStudent() {
        this.isVerified = false;
        this.stopCamera();
        this.statusText.textContent = "Select another student to continue";
        this.statusBox.classList.remove('verified');
      }
      
      hideVerified() {
        this.verifiedTick.classList.remove('show');
      }

      // Other methods (addNewStudent, markAllUnmarkedAsAbsent, etc.)
      markAllUnmarkedAsAbsent() {
        if (!confirm('Are you sure? This will mark ALL unmarked students as ABSENT.')) {
          return;
        }
        
        let count = 0;
        this.students.forEach(student => {
          if (!student.scanned) {
            student.scanned = true;
            student.present = false;
            student.check_in_time = '00:00:00';
            count++;
          }
        });
        
        this.database.saveStudents(this.students);
        this.renderStudents();
        this.updateSummary();
        this.clearSelection();
        
        this.showDatabaseStatus(`Marked ${count} students as absent`, 'info');
      }

     addNewStudent() {
  const name = prompt('Enter student name:');
  if (!name) return;
  
  const id = prompt('Enter student ID (e.g., LEH2024001):');
  if (!id) return;
  
  const course = prompt('Enter course (e.g., BCA, BBA, B.Tech):');
  if (!course) return;
  
  const newStudent = {
    id: id,
    name: name,
    course: course,
    present: false,
    scanned: false
  };
  
  // Check if ID already exists
  const existingStudent = this.students.find(s => s.id === id);
  if (existingStudent) {
    this.showDatabaseStatus(`Student ID ${id} already exists!`, 'error');
    return;
  }
  

        
        this.students.push(newStudent);
        this.database.saveStudents(this.students);
        this.renderStudents();
        this.updateSummary();
        
        this.showDatabaseStatus(`Student ${name} added successfully!`, 'success');
      }

      exportData() {
        const data = {
          students: this.students,
          exportedAt: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showDatabaseStatus('Data exported successfully!', 'success');
      }

      importData() {
        this.importFile.click();
      }

      handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.students && Array.isArray(data.students)) {
              this.students = data.students;
              this.database.saveStudents(this.students);
              this.loadStudents();
              this.clearSelection();
              this.showDatabaseStatus('Data imported successfully!', 'success');
            } else {
              this.showDatabaseStatus('Invalid file format', 'error');
            }
          } catch (error) {
            console.error('Error importing data:', error);
            this.showDatabaseStatus('Error importing data', 'error');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      }

      resetTodayAttendance() {
        if (!confirm('Reset today\'s attendance? This will clear ALL marks for today.')) {
          return;
        }
        
        this.students.forEach(student => {
          student.scanned = false;
          student.present = false;
          student.check_in_time = null;
        });
        
        this.database.saveStudents(this.students);
        this.loadStudents();
        this.clearSelection();
        
        this.showDatabaseStatus('Today\'s attendance reset', 'info');
      }

      startNewDay() {
        if (!confirm('Start new day? Current data will be archived.')) {
          return;
        }
        
        // Archive current data
        const archiveKey = `attendance_archive_${new Date().toISOString().split('T')[0]}`;
        localStorage.setItem(archiveKey, JSON.stringify(this.students));
        
        // Reset all students
        this.students.forEach(student => {
          student.scanned = false;
          student.present = false;
          student.check_in_time = null;
        });
        
        this.database.saveStudents(this.students);
        this.loadStudents();
        this.clearSelection();
        this.showCurrentDate();
        
        this.showDatabaseStatus('New day started! Previous data archived.', 'success');
      }

      showDatabaseStatus(message, type = 'info') {
        const colors = {
          info: '#e7f3ff',
          success: '#d4edda',
          error: '#f8d7da'
        };
        
        const textColors = {
          info: '#004085',
          success: '#155724',
          error: '#721c24'
        };
        
        this.dbStatus.textContent = message;
        this.dbStatus.style.background = colors[type];
        this.dbStatus.style.color = textColors[type];
        this.dbStatus.className = "database-status show";
        
        setTimeout(() => {
          this.dbStatus.className = "database-status";
        }, 5000);
      }
    }

    // Initialize system when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new AttendanceSystem();
    });
  </script>
</body>
</html>
